<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <script type="text/javascript" src="./underscore-min.js"></script>
    <script type="text/javascript" src="./explosionParticles.js"></script>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<canvas id="myCanvas" width="600" height="380"></canvas>

<script>
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext("2d");

	var start = new Date();
	var score = 0;
	var gameOver = false;
	var gameWon = false;

	var shipX = 10;
	var shipY = canvas.height / 2;
	var shipHeight = 10;
	var shipWidth = 20;
	var shipSpeed = 2;
	var lives = 3;
	var touchable = true;
	var blinkTimer = null;
	var blinkTime = 5;

	var missileX = shipX + shipWidth;
	var missileY = shipY + shipHeight/2;
	var missileHeight = 2;
	var missileWidth = 5;
	var missileSpeed = 3;
	var missiles = [{x: missileX, y: missileY, originalX: missileX}];
	var missileSpace = 35;

	var enemyYPositions = [40, 80, 120, 160, 200, 240, 280, 320, 360];
	var enemyTimer = _.range(1, 21);
	var enemyX = canvas.width + 50;
	var enemyHeight = 14;
	var enemyWidth = 22;
	var enemySpeed = 2;
	var enemies = [];
	for(var e=0;e<15;e++) {
		enemies.push({x: enemyX, y: _.sample(enemyYPositions), height: enemyHeight, width: enemyWidth, 
						timing: _.sample(enemyTimer), onField: true});
	}

	var zigzagEnemyTimer = _.range(10, 21);
	var zigzagEnemyHeight = 10;
	var zigzagEnemyWidth = 20;
	var zigzagEnemyXSpeed = 2;
	var zigzagEnemyYSpeed = 2;
	var verticalMovement = 40;
	var zigzagEnemies = [];
	for(var e=0;e<6;e++) {
		var originalY = _.sample(enemyYPositions);
		zigzagEnemies.push({x: enemyX, y: originalY, height: zigzagEnemyHeight, width: zigzagEnemyWidth, 
							timing: _.sample(zigzagEnemyTimer), ySpeed: zigzagEnemyYSpeed, originalY: originalY, onField: true});

	}

	var shootingEnemyTimer = _.range(15, 25);
	var shootingEnemyWidth = 14;
	var shootingEnemyHeight = 10;
	var shootingEnemySpeed = 1;
	var missileTiming = 300;
	var shootingEnemies = [];
	for(var s=0;s<4;s++) {
		shootingEnemies.push({x: enemyX, y: _.sample(enemyYPositions), height: shootingEnemyHeight, width: shootingEnemyWidth,
								timing: _.sample(shootingEnemyTimer), onField: true, missiles: []});
	}

	var upPressed = false;
	var downPressed = false;
	var rightPressed = false;
	var leftPressed = false;
	var spacePressed = false;

	document.addEventListener("keydown", keyDownHandler, false);
	document.addEventListener("keyup", keyUpHandler, false);

	function keyDownHandler(e) {
		if(e.key == "Up" || e.key == "ArrowUp") {
			upPressed = true;
		} else if(e.key == "Down" || e.key == "ArrowDown") {
			downPressed = true;
		} else if(e.key == "Right" || e.key == "ArrowRight") {
			rightPressed = true;
		} else if(e.key == "Left" || e.key == "ArrowLeft") {
			leftPressed = true;
		} else if(e.keyCode == 32) {
			spacePressed = true;
		}
	}

	function keyUpHandler(e) {
		if(e.key == "Up" || e.key == "ArrowUp") {
			upPressed = false;
		} else if(e.key == "Down" || e.key == "ArrowDown") {
			downPressed = false;
		} else if(e.key == "Right" || e.key == "ArrowRight") {
			rightPressed = false;
		} else if(e.key == "Left" || e.key == "ArrowLeft") {
			leftPressed = false;
		} else if(e.keyCode == 32) {
			spacePressed = false;
		}
	}

	function buttonActions() {
		if(upPressed) {
			shipY -= shipSpeed;
			if(shipY < 0) {
				shipY = 0;
			}
		}

		if(downPressed) {
			shipY += shipSpeed;
			if(shipY + shipHeight > canvas.height) {
				shipY = canvas.height - shipHeight;
			}
		} 

		if(rightPressed) {
			shipX += shipSpeed;
			if(shipX + shipWidth > canvas.width) {
				shipX = canvas.width - shipWidth;
			}
		} 

		if(leftPressed) {
			shipX -= shipSpeed;
			if(shipX < 0) {
				shipX = 0;
			}
		}

		if(spacePressed) {
			missileX = shipX + shipWidth;
			missileY = shipY + shipHeight/2;
			fire();
		}
	}

	function fire() {
		if(missiles.length === 0 || missiles[missiles.length-1].x - missiles[missiles.length-1].originalX > missileSpace) {
			missiles.push({x: missileX, y: missileY, originalX: missileX});
		}
	}

	function enemyFire(enemy) {
		var m = enemy.missiles;
		if(m.length === 0 || m[m.length-1].originalX - m[m.length-1].x > missileTiming) {
			var yPos = enemy.y + enemy.height/2;
			m.push({x: enemy.x, y: yPos, originalX: enemy.x, width: missileWidth, height: missileHeight});
		}
	}

	function shipCollisionDetection() {
		for(var x=0;x<enemies.length;x++) {
			var enemy = enemies[x];
			shipEnemyCollisionDetection(enemy, enemies, x);
		}
		for(var z=0;z<zigzagEnemies.length;z++) {
			var enemy = zigzagEnemies[z];
			shipEnemyCollisionDetection(enemy, zigzagEnemies, z);
		}
		for(var s=0;s<shootingEnemies.length;s++) {
			var enemy = shootingEnemies[s];
			var enemyMissiles = enemy.missiles;
			shipEnemyCollisionDetection(enemy, shootingEnemies, s);
			for(var m=0;m<enemyMissiles.length;m++) {
				var missile = enemyMissiles[m];
				shipEnemyCollisionDetection(missile, enemyMissiles, m);
			}
		}
	}

	function shipEnemyCollisionDetection(enemy, enemyArray, index) {
		if(shipX + shipWidth > enemy.x && shipX < enemy.x + enemy.width && 
			shipY + shipHeight > enemy.y && shipY < enemy.y + enemy.height && touchable) {
			lives -= 1;
			touchable = false;
			blinkTimer = new Date();
			explode(enemy.x, enemy.y);
			enemyArray.splice(index, 1);
			if(!lives) {
				gameOver = true;
			} else {
				shipX = 10;
				shipY = canvas.height/2; 
			}
		}
	}

	function missileCollisionDetection() {
		for(var x=0;x<enemies.length;x++) {
			var enemy = enemies[x];
			missileEnemyCollisionDetection(enemy, enemies, x);
		}
		for(var z=0;z<zigzagEnemies.length;z++) {
			var enemy = zigzagEnemies[z];
			missileEnemyCollisionDetection(enemy, zigzagEnemies, z);
		}
		for(var s=0;s<shootingEnemies.length;s++) {
			var enemy = shootingEnemies[s];
			missileEnemyCollisionDetection(enemy, shootingEnemies, s);
		}
	}

	function missileEnemyCollisionDetection(enemy, enemyArray, enemyIndex) {
		for(var m=0;m<missiles.length;m++) {
			var missile = missiles[m];
			if(missile.x + missileWidth > enemy.x && missile.x < enemy.x + enemy.width && 
				missile.y + missileHeight > enemy.y && missile.y < enemy.y + enemyHeight) {
				explode(enemy.x, enemy.y);
				missiles.splice(m, 1);
				enemyArray.splice(enemyIndex, 1);
				score += 1;
			}
		}
	}

	function checkTouchable() {
		var elapsed = (new Date() - blinkTimer)/1000;
		if(elapsed >= blinkTime) {
			touchable = true;
			blinkTimer = null;
		}
	}

	function drawShip() {
		var elapsed = (new Date() - blinkTimer)/1000;
		var decimal = Math.round(elapsed * 10);
		if(!blinkTimer || decimal % 2 == 1) {
			ctx.beginPath();
			ctx.rect(shipX, shipY, shipWidth, shipHeight);
			ctx.fillStyle = "#F00000";
			ctx.fill();
			ctx.closePath();
		} else {
			ctx.beginPath();
			ctx.rect(shipX, shipY, shipWidth, shipHeight);
			ctx.fillStyle = "#FFD9D9";
			ctx.fill();
			ctx.closePath();
		}
	}

	function drawMissiles() {
		if(missiles.length > 0) {
			for(var m=0;m<missiles.length;m++) {
				missile = missiles[m];
				if(missile.x < canvas.width + missileSpace) {
					ctx.beginPath();
					ctx.rect(missile.x, missile.y, missileWidth, missileHeight);
					ctx.fillStyle = "#F188C1";
					ctx.fill();
					ctx.closePath();
				}
				if(missile.x > canvas.width + missileSpace) {
					missiles.splice(m, 1);
				}
			}
		}
	}

	function drawEnemies() {
		var elapsed = (new Date() - start)/1000;
		for(var e=0;e<enemies.length;e++) {
			enemy = enemies[e];
			if(elapsed >= enemy.timing && enemy.x + enemy.width > 0) {
				ctx.beginPath();
				ctx.rect(enemy.x, enemy.y, enemyWidth, enemyHeight);
				ctx.fillStyle = "green";
				ctx.fill();
				ctx.closePath();
				enemy.x -= enemySpeed;
			}
			if(enemy.x + enemy.width <= 0) {
				enemies.splice(e, 1);
			}
		}
		if(enemies.length === 0 && zigzagEnemies.length === 0 && shootingEnemies.length === 0) {
			gameWon = true;
		}
	}

	function drawZigzagEnemies() {
		var elapsed = (new Date() - start)/1000;
		for(var z=0;z<zigzagEnemies.length;z++) {
			var enemy = zigzagEnemies[z];
			if(elapsed >= enemy.timing && enemy.x + enemy.width > 0) {
				if(enemy.y + enemy.ySpeed > canvas.height) {
					enemy.ySpeed = -enemy.ySpeed;
				} else if(enemy.y + enemy.ySpeed < 0) {
					enemy.ySpeed = -enemy.ySpeed;
				} else if(Math.abs(enemy.y - enemy.originalY) > verticalMovement) {
					enemy.ySpeed = -enemy.ySpeed;
				}
				ctx.beginPath();
				ctx.rect(enemy.x, enemy.y, zigzagEnemyWidth, zigzagEnemyHeight);
				ctx.fillStyle = "purple";
				ctx.fill();
				ctx.closePath();
				enemy.x -= zigzagEnemyXSpeed;
				enemy.y += enemy.ySpeed;
			}
			if(enemy.x + enemy.width <= 0) {
				zigzagEnemies.splice(z, 1);
			}
		}
	}

	function drawShootingEnemies() {
		var elapsed = (new Date() - start)/1000;
		for(var s=0;s<shootingEnemies.length;s++) {
			var enemy = shootingEnemies[s];
			if(elapsed >= enemy.timing && enemy.x + enemy.width > 0) {
				ctx.beginPath();
				ctx.rect(enemy.x, enemy.y, enemy.width, enemy.height);
				ctx.fillStyle = "#00478A";
				ctx.fill();
				ctx.closePath();
				enemy.x -= shootingEnemySpeed;
				enemyFire(enemy);
				drawEnemyMissiles(enemy);
				enemyMissileMovement(enemy);
			}
		}
	}

	function drawEnemyMissiles(enemy) {
		var m = enemy.missiles
		if(m.length > 0) {
			for(var x=0;x<m.length;x++) {
				missile = m[x];
				if(missile.x < canvas.width + missileSpace) {
					ctx.beginPath();
					ctx.rect(missile.x, missile.y, missileWidth, missileHeight);
					ctx.fillStyle = "#00478A";
					ctx.fill();
					ctx.closePath();
				}
				if(missile.x + missile.width < 0) {
					m.splice(x, 1);
				}
			}
		}
	}

	function drawScore() {
		ctx.beginPath();
		ctx.font = "16px Helvetica";
		ctx.fillStyle = "#0095DD";
		ctx.fillText("Score: "+score, 8, 20);
	}

	function drawLives() {
		ctx.beginPath();
		ctx.font = "16px Helvetica";
		ctx.fillStyle = "#0095DD";
		ctx.fillText("Lives: "+lives, canvas.width-65, 20);
	}

	function drawGameState() {
		if(gameWon && !gameOver) {
			ctx.beginPath();
			ctx.font = "48px Helvetica";
			ctx.fillStyle = "#0095DD";
			ctx.fillText("YOU WIN", 200, canvas.height/2);
		}
		if(gameOver) {
			ctx.beginPath();
			ctx.font = "48px Helvetica";
			ctx.fillStyle = "#C2130A"
			ctx.fillText("GAME OVER", 150, canvas.height/2);
		}
	}

	function missileMovement() {
		for(var x=0;x<missiles.length;x++) {
			missile = missiles[x];
			if(missile.x < canvas.width + missileSpace) {
				missile.x += missileSpeed;
			}
		}
	}

	function enemyMissileMovement(enemy) {
		for(var m=0;m<enemy.missiles.length;m++) {
			var missile = enemy.missiles[m];
			if(missile.x < canvas.width + missileTiming) {
				missile.x -= missileSpeed;
			}
		}
	}

	function loop() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		drawShip();
		drawMissiles();
		drawEnemies();
		drawZigzagEnemies();
		drawShootingEnemies();
		drawLives();
		drawScore();
		drawGameState();
		missileMovement();
		buttonActions();
		checkTouchable();
		shipCollisionDetection();
		missileCollisionDetection();
		for(var i=0;i<particles.length;i++) {
			particles[i].draw();
			particles[i].update();
		}

		requestAnimationFrame(loop);
	}

	loop();

</script>

</body>
</html>