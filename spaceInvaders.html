<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <script type="text/javascript" src="./underscore-min.js"></script>
    <script type="text/javascript" src="./explosionParticles.js"></script>
    <script type="text/javascript" src="./ship.js"></script>
	<script type="text/javascript" src="./missile.js"></script>
	<script type="text/javascript" src="./enemies/enemy.js"></script>
	<script type="text/javascript" src="./enemies/standardEnemy.js"></script>
	<script type="text/javascript" src="./enemies/zigzagEnemy.js"></script>
	<script type="text/javascript" src="./enemies/shootingEnemy.js"></script>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<canvas id="myCanvas" width="600" height="380"></canvas>

<script>
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext("2d");

	var start = new Date();
	var score = 0;
	var gameOver = false;
	var gameWon = false;

	var ship = new Ship(30, canvas.height/2);

	var missileX = ship.x + ship.width;
	var missileY = ship.y + ship.height/2;
	var missileHeight = 2;
	var missileWidth = 5;
	var missileSpeed = 3;
	var missiles = [];
	var missileSpace = 35;

	var enemyYPositions = [40, 80, 120, 160, 200, 240, 280, 320, 360];
	var enemyTimer = _.range(1, 30);
	var enemyX = canvas.width + 50;
	var enemyHeight = 14;
	var enemyWidth = 22;
	var enemySpeed = 2;
	var enemies = [];
	for(var e=0;e<20;e++) {
		enemies.push({x: enemyX, y: _.sample(enemyYPositions), height: enemyHeight, width: enemyWidth, 
						timing: _.sample(enemyTimer), onField: true});
	}

	var zigzagEnemyTimer = _.range(10, 40);
	var zigzagEnemyHeight = 10;
	var zigzagEnemyWidth = 20;
	var zigzagEnemyXSpeed = 2;
	var zigzagEnemyYSpeed = 2;
	var verticalMovement = 40;
	var zigzagEnemies = [];
	for(var e=0;e<12;e++) {
		var originalY = _.sample(enemyYPositions);
		zigzagEnemies.push({x: enemyX, y: originalY, height: zigzagEnemyHeight, width: zigzagEnemyWidth, 
							timing: _.sample(zigzagEnemyTimer), ySpeed: zigzagEnemyYSpeed, originalY: originalY, onField: true});

	}

	var shootingEnemyTimer = _.range(30, 60);
	var shootingEnemies = [];
	for(var s=0;s<8;s++) {
		let shooter = new ShootingEnemy({y: _.sample(enemyYPositions), timing: _.sample(shootingEnemyTimer), missiles: []});
		shootingEnemies.push(shooter);
	}

	var upPressed = false;
	var downPressed = false;
	var rightPressed = false;
	var leftPressed = false;
	var spacePressed = false;

	document.addEventListener("keydown", keyDownHandler, false);
	document.addEventListener("keyup", keyUpHandler, false);

	function keyDownHandler(e) {
		if(e.key == "Up" || e.key == "ArrowUp") {
			upPressed = true;
		} else if(e.key == "Down" || e.key == "ArrowDown") {
			downPressed = true;
		} else if(e.key == "Right" || e.key == "ArrowRight") {
			rightPressed = true;
		} else if(e.key == "Left" || e.key == "ArrowLeft") {
			leftPressed = true;
		} else if(e.keyCode == 32) {
			spacePressed = true;
		}
	}

	function keyUpHandler(e) {
		if(e.key == "Up" || e.key == "ArrowUp") {
			upPressed = false;
		} else if(e.key == "Down" || e.key == "ArrowDown") {
			downPressed = false;
		} else if(e.key == "Right" || e.key == "ArrowRight") {
			rightPressed = false;
		} else if(e.key == "Left" || e.key == "ArrowLeft") {
			leftPressed = false;
		} else if(e.keyCode == 32) {
			spacePressed = false;
		}
	}

	function buttonActions() {
		if(upPressed) {
			ship.update(0, -ship.speed);
		}

		if(downPressed) {
			ship.update(0, ship.speed);
		} 

		if(rightPressed) {
			ship.update(ship.speed, 0);
		} 

		if(leftPressed) {
			ship.update(-ship.speed, 0);
		}

		if(spacePressed) {
			if(shipCanFire()) {
				ship.fire();
			}
		}
	}

	function shipCollisionDetection() {
		for(var x=0;x<enemies.length;x++) {
			var enemy = enemies[x];
			ship.hitByEnemy(enemy, enemies, x);
		}
		for(var z=0;z<zigzagEnemies.length;z++) {
			var enemy = zigzagEnemies[z];
			ship.hitByEnemy(enemy, zigzagEnemies, z);
		}
		for(var s=0;s<shootingEnemies.length;s++) {
			var enemy = shootingEnemies[s];
			var enemyMissiles = enemy.missiles;
			ship.hitByEnemy(enemy, shootingEnemies, s);
			for(var m=0;m<enemyMissiles.length;m++) {
				var missile = enemyMissiles[m];
				ship.hitByEnemy(missile, enemyMissiles, m);
			}
		}
	}

	function missileCollisionDetection() {
		for(var x=0;x<enemies.length;x++) {
			var enemy = enemies[x];
			missileEnemyCollisionDetection(enemy, enemies, x);
		}
		for(var z=0;z<zigzagEnemies.length;z++) {
			var enemy = zigzagEnemies[z];
			missileEnemyCollisionDetection(enemy, zigzagEnemies, z);
		}
		for(var s=0;s<shootingEnemies.length;s++) {
			var enemy = shootingEnemies[s];
			missileEnemyCollisionDetection(enemy, shootingEnemies, s);
		}
	}

	function missileEnemyCollisionDetection(enemy, enemyArray, enemyIndex) {
		let onFieldMissiles = onFieldCollection(missiles);
		for(var m=0;m<onFieldMissiles.length;m++) {
			var missile = onFieldMissiles[m];
			if(!enemy.onField || !missile.onField) {
				continue;
			} else if(missile.x + missileWidth > enemy.x && missile.x < enemy.x + enemy.width && 
				missile.y + missileHeight > enemy.y && missile.y < enemy.y + enemyHeight) {
				explode(enemy.x, enemy.y);
				enemy.onField = false;
				missile.onField = false;
				score += 1;
			}
		}
	}

	function drawMissiles() {
		let onFieldMissiles = onFieldCollection(missiles);
		if(onFieldMissiles.length > 0) {
			for(var m=0;m<onFieldMissiles.length;m++) {
				missile = onFieldMissiles[m];
				if(missile.x < canvas.width + missileSpace) {
					ctx.beginPath();
					ctx.rect(missile.x, missile.y, missileWidth, missileHeight);
					ctx.fillStyle = "#F188C1";
					ctx.fill();
					ctx.closePath();
				}
				if(missile.x > canvas.width + missileSpace) {
					missile.onField = false;
				}
			}
		}
	}

	function drawEnemies() {
		var elapsed = (new Date() - start)/1000;
		let onFieldEnemies = onFieldCollection(enemies);
		for(var e=0;e<onFieldEnemies.length;e++) {
			enemy = onFieldEnemies[e];
			if(elapsed >= enemy.timing && enemy.x + enemy.width > 0) {
				ctx.beginPath();
				ctx.rect(enemy.x, enemy.y, enemyWidth, enemyHeight);
				ctx.fillStyle = "green";
				ctx.fill();
				ctx.closePath();
				enemy.x -= enemySpeed;
			} else if(enemy.x + enemy.width <= 0) {
				enemy.onField = false;
			}
		}
	}

	function drawZigzagEnemies() {
		var elapsed = (new Date() - start)/1000;
		let onFieldEnemies = onFieldCollection(zigzagEnemies);
		for(var z=0;z<onFieldEnemies.length;z++) {
			var enemy = onFieldEnemies[z];
			if(elapsed >= enemy.timing && enemy.x + enemy.width > 0) {
				if(enemy.y + enemy.ySpeed > canvas.height) {
					enemy.ySpeed = -enemy.ySpeed;
				} else if(enemy.y + enemy.ySpeed < 0) {
					enemy.ySpeed = -enemy.ySpeed;
				} else if(Math.abs(enemy.y - enemy.originalY) > verticalMovement) {
					enemy.ySpeed = -enemy.ySpeed;
				}
				ctx.beginPath();
				ctx.rect(enemy.x, enemy.y, zigzagEnemyWidth, zigzagEnemyHeight);
				ctx.fillStyle = "purple";
				ctx.fill();
				ctx.closePath();
				enemy.x -= zigzagEnemyXSpeed;
				enemy.y += enemy.ySpeed;
			} else if(enemy.x + enemy.width <= 0) {
				enemy.onField = false;
			}
		}
	}

	function drawShootingEnemies() {
		var elapsed = (new Date() - start)/1000;
		for(var s=0;s<shootingEnemies.length;s++) {
			var enemy = shootingEnemies[s];
			if(!enemy.onField) {
				drawEnemyMissiles(enemy);
				enemyMissileMovement(enemy);
				continue;
			} else if(elapsed >= enemy.timing && enemy.x + enemy.width > 0) {
				enemy.draw();
				enemy.x -= enemy.speed;
				if(enemy.canFire()) {
					enemy.fire();
				}
				drawEnemyMissiles(enemy);
				enemyMissileMovement(enemy);
			} else if(enemy.x + enemy.width <= 0) {
				enemy.onField = false;
			}
		}
	}

	function drawEnemyMissiles(enemy) {
		let m = onFieldCollection(enemy.missiles);
		if(m.length > 0) {
			for(var x=0;x<m.length;x++) {
				missile = m[x];
				if(missile.x < canvas.width + missileSpace) {
					ctx.beginPath();
					ctx.rect(missile.x, missile.y, missileWidth, missileHeight);
					ctx.fillStyle = "#00478A";
					ctx.fill();
					ctx.closePath();
				} else if(missile.x + missile.width < 0) {
					missile.onField = false;
				}
			}
		}
	}

	function drawScore() {
		ctx.beginPath();
		ctx.font = "16px Helvetica";
		ctx.fillStyle = "#0095DD";
		ctx.fillText("Score: "+score, 8, 20);
	}

	function drawLives() {
		ctx.beginPath();
		ctx.font = "16px Helvetica";
		ctx.fillStyle = "#0095DD";
		ctx.fillText("Lives: "+ship.lives, canvas.width-65, 20);
	}

	function drawGameState() {
		if(gameWon && !gameOver) {
			ctx.beginPath();
			ctx.font = "48px Helvetica";
			ctx.fillStyle = "#0095DD";
			ctx.fillText("YOU WIN", 200, canvas.height/2);
		}
		if(gameOver) {
			ctx.beginPath();
			ctx.font = "48px Helvetica";
			ctx.fillStyle = "#C2130A"
			ctx.fillText("GAME OVER", 150, canvas.height/2);
		}
	}

	function missileMovement() {
		let shipM = onFieldCollection(missiles)
		for(var x=0;x<shipM.length;x++) {
			missile = shipM[x];
			if(missile.x < canvas.width + missileSpace) {
				missile.x += missileSpeed;
			}
		}
	}

	function enemyMissileMovement(enemy) {
		let enemyM = onFieldCollection(enemy.missiles)
		for(var m=0;m<enemyM.length;m++) {
			var missile = enemyM[m];
			if(missile.x < canvas.width + enemy.missileTiming) {
				missile.x -= enemy.missileSpeed;
			}
		}
	}

	function onFieldCollection(array) {
		if(array.length > 0) {
			return array.filter(function(a) { return a.onField; });
		} else {
			return array
		}
	}

	function isGameWon() {
		let onFieldEnemies = onFieldCollection(_.flatten(enemies, zigzagEnemies, shootingEnemies));
		if (!(onFieldEnemies.length > 0)) {
			gameWon = true;
		}
	}

	function loop() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		drawMissiles();
		drawEnemies();
		drawZigzagEnemies();
		drawShootingEnemies();
		drawLives();
		drawScore();
		drawGameState();
		missileMovement();
		buttonActions();
		shipCollisionDetection();
		missileCollisionDetection();
		for(var i=0;i<particles.length;i++) {
			particles[i].draw();
			particles[i].update();
		}
		ship.draw();
		isGameWon();
		requestAnimationFrame(loop);
	}

	loop();

</script>

</body>
</html>